<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Manager</title>

  <!-- 1) Netlify Identity widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- 2) Tell Decap we will initialize manually (MUST be BEFORE the CMS script) -->
  <script>window.CMS_MANUAL_INIT = true;</script>

  <!-- 3) Decap CMS app -->
  <script src="https://unpkg.com/decap-cms@latest/dist/decap-cms.js"></script>
</head>
<body>
  <!-- Small helper UI -->
  <div style="font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px;">
    <button id="openLogin" style="padding:10px 16px;border-radius:8px;cursor:pointer">
      Open Login / Sign up
    </button>
    <span id="userState" style="margin-left:12px;color:#555"></span>
  </div>

  <script>
    // Identity login helpers
    if (window.netlifyIdentity) {
      netlifyIdentity.on('init', (user) => {
        document.getElementById('userState').textContent = user ? 'Signed in' : 'Signed out';
        if (!user) netlifyIdentity.open('login');
      });
      netlifyIdentity.on('login', () => location.reload());
      netlifyIdentity.on('logout', () => location.reload());
      document.getElementById('openLogin').onclick = () => netlifyIdentity.open('login');
    }

    // 4) Manual init config â€” avoids fetching /admin/config.yml
    (function () {
      const cfg = {
        backend: { name: 'git-gateway', branch: 'main' }, // change to 'master' if your repo default is master
        media_folder: 'assets/uploads',
        public_folder: '/assets/uploads',
        collections: [
          {
            name: 'articles',
            label: 'Articles',
            folder: 'articles',
            create: true,
            slug: '{{slug}}',
            extension: 'md',
            preview_path: 'article.html?post={{slug}}',
            fields: [
              { label: 'Title',   name: 'title',   widget: 'string'   },
              { label: 'Summary', name: 'summary', widget: 'text'     },
              { label: 'Body',    name: 'body',    widget: 'markdown' },
            ]
          }
        ]
      };
      CMS.init({ config: cfg });
    })();
  </script>
</body>
</html>
